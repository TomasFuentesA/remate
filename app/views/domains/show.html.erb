<% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
<%= link_to 'Volver a los datos de la empresa', @legal_persona, class: "btn btn-primary" %>
<div class = "container-fluid">
  <div class= "row">
    <div class= "card" style= "width: 150rem;">
      <div class="col-sm-12 card-body">
      <h1 align="center"> Datos de la empresa: <%= @legal_persona.name %> </h1>
        <div class= "row">
          <div class= "col-md-6">
            <label for= "name"> Nombre de la empresa: </label>
            <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= @legal_persona.name %>" readonly>
          </div>
          <div class="col-md-3">
            <label for="rut"> Rut de la empresa: </label>
            <input type="text" id="rut" class="form-control" placeholder="Rut" disable value="<%= @legal_persona.rut %>" readonly>
          </div>
          <div class="col-md-3">
            <label for="acciones"> Acciones: </label>
            <input type="text" id="acciones" class="form-control" placeholder="Acciones" disable value="<%= @legal_persona.acciones %>" readonly>
          </div>
        </div>
        <div class= "row">
          <div class="col-md-4">
            <label for="fantasia"> Nombre de fantasía: </label>
            <input type="text" id="fantasia" class="form-control" placeholder="Fantasia" disable value="<%= @legal_persona.fantasy_name %>" readonly>
          </div>
          <div class="col-md-4">
            <label for="Alias"> Alias: </label>
            <input type="text" id="alias" class="form-control" placeholder="Alias" disable value="<%= @legal_persona.alias %>" readonly>
          </div>
          <div class="col-md-4">
            <label for="Web"> Web: </label>
            <input type="text" id="web" class="form-control" placeholder="Web" disable value="<%= @legal_persona.web %>" readonly>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="card" style="width: 150rem;">
      <div class="col-sm-12 card-body">
      <h1 align="center">Escrituras de <%= @legal_persona.name%></h1> 
        <div class="row">
          <div class="col-md-6">
            <label for="name"> Modalidad: </label>
            <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= @domain.type_modality %>" readonly>
          </div>
          <div class="col-md-6">
            <label for="name"> Porcentaje </label>
            <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= @domain.percentage %>" readonly>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <label for="name"> Precio: </label>
            <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= @domain.price %>" readonly>
          </div>
          <div class="col-md-6">
            <label for="name"> Fecha de posesion </label>
            <input type="text" id="name" class="form-control" placeholder="Name" disable
              value="<%= @domain.date_posetion %>" readonly>
          </div>
        </div>
        <div class="row">
          <%if @domain.type_modality == "Creacion de empresa"%>
            <div class="col-md-12">
            <label for="name"> Creador(es): </label>
            <% DomainRol.order(:id).each do |domrol| %>
              <% if domrol.domain_id == @domain.id %>
                <% if domrol.type_rol == "Creador"%>
                  <% if domrol.type_member == "Natural" %>
                    <% Persona.order(:id).each do |persona| %>
                      <% if persona.id == domrol.persona_id%>
                        <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= persona.name%> <%= persona.last_name1%>/<%= persona.rut%> " readonly>
                        <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                        <br>
                        <%= link_to "Añadir Persona", new_legal_persona_domain_rol_persona_member_path(@legal_persona.id, domrol.id) ,class:"btn btn-primary"%>
                        <%= link_to 'Edit', edit_domain_rol_path(domrol), class: "btn btn-warning" %>
                        <%= link_to 'Destroy', domrol, method: :delete, data: { confirm: 'Are you sure?' }, class: "btn btn-danger"  %>
                      <%end%>
                    <%end%>
                  <%else%>
                    <% LegalPersona.order(:id).each do |legalpersona| %>
                      <% if legalpersona.id == domrol.persona_id%>
                        <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= legalpersona.name%>/<%= legalpersona.rut%>" readonly>
                        <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                        <br>
                        <%= link_to "Añadir Persona", new_legal_persona_domain_rol_persona_member_path(@legal_persona.id, domrol.id) ,class:"btn btn-primary"%>
                        <%= link_to 'Edit', edit_domain_rol_path(domrol), class: "btn btn-warning"  %>
                        <%= link_to 'Destroy', domrol, method: :delete, data: { confirm: 'Are you sure?' },class: "btn btn-danger" %>
                      <%end%>
                    <%end%>
                  <%end%>
                <%end%>
              <%end%>
            <%end%>
            </div>
          <%elsif @domain.type_modality == "Modificacion de empresa"%>
            <div class="col-md-12">
            <label for="name"> Modificador(es): </label>
            <% DomainRol.order(:id).each do |domrol| %>
              <% if domrol.domain_id == @domain.id %>
                <% if domrol.type_rol == "Modificador"%>
                  <% if domrol.type_member == "Natural" %>
                    <% Persona.order(:id).each do |persona| %>
                      <% if persona.id == domrol.persona_id%>
                        <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= persona.name%> <%= persona.last_name1%>/<%= persona.rut%> " readonly>
                        <br>
                        <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                      <%end%>
                    <%end%>
                  <%else%>
                    <% LegalPersona.order(:id).each do |legalpersona| %>
                      <% if legalpersona.id == domrol.persona_id%>
                        <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= legalpersona.name%>/<%= legalpersona.rut%>" readonly>
                        <br>
                        <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                      <%end%>
                    <%end%>
                  <%end%>
                <%end%>
              <%end%>
            <%end%>
            </div>
          <%else%>
            <div class="col-md-6">
              <label for="name"> Vendedor(es): </label>
              <% DomainRol.order(:id).each do |domrol| %>
                <% if domrol.domain_id == @domain.id %>
                  <% if domrol.type_rol == "Vendedor"%>
                    <% if domrol.type_member == "Natural" %>
                      <% Persona.order(:id).each do |persona| %>
                        <% if persona.id == domrol.persona_id%>
                          <div class="form-row">
                            <div class="col-md-7 mb-4">
                              <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= persona.name%> <%= persona.last_name1%>/<%= persona.rut%> " readonly>
                            </div>
                              <div class="col-md-5 mb-3">
                              <button class="btn btn-success" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">Añadir Comprador</button>                 
                              <%= link_to 'Añadir Comprador', new_domain_rol_comprador_path(domrol), class: "btn btn-success" %>
                            </div>
                          </div>    
                        <%end%>
                      <%end%>
                    <%else%>
                      <% LegalPersona.order(:id).each do |legalpersona| %>
                        <% if legalpersona.id == domrol.persona_id%>
                          <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= legalpersona.name%>/<%= legalpersona.rut%>" readonly>
                          <br>
                          <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                          <button class="btn btn-success" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">Añadir Comprador</button>
                          <%= link_to 'Añadir comprador', new_domain_rol_comprador_path(domrol), class: "btn btn-success" %>
                        <%end%>
                      <%end%>
                    <%end%>
                  <%end%>
                <%end%>
              <%end%>
            </div>
          <%end%>        
          <div class="col-md-6">
          <% if @domain.type_modality == "Compra y Venta de acciones"%>
            <label for="name"> Comprador(es): </label>
            <% DomainRol.order(:id).each do |domrol| %>
              <% if domrol.domain_id == @domain.id %>
                <% Comprador.order(:id).each do |comp| %>
                  <% if comp.domain_rol_id == domrol.id %>
                    <% if comp.type_member == "Natural" %>
                      <% Persona.order(:id).each do |perso| %>
                        <% if comp.persona_id == perso.id %>
                          <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                          <div class="form-row">
                            <div class="col-md-6 mb-4">
                              <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= perso.name%> <%= perso.last_name1%> / <%= perso.rut %>" readonly>
                            </div>
                            <div class="col-md-6 mb-4">
                              <%= link_to 'Destroy', comp, method: :delete, data: { confirm: 'Are you sure?' },class: "btn btn-danger" %>
                            </div>
                               
                          </div>  
                        <%end%>
                      <%end%>
                    <%else%>
                      <% LegalPersona.order(:id).each do |legalp| %>
                        <% if comp.persona_id == legalp.id %>
                          <% @legal_persona = LegalPersona.find(@domain.domainable_id) %>
                          <div class="form-row">
                            <div class="col-md-6 mb-3">
                              <input type="text" id="name" class="form-control" placeholder="Name" disable value="<%= legalp.name%>/<%= legalp.rut%>" readonly>
                            </div>
                            <div class="col-md-6 mb-4">
                              <%= link_to 'Destroy', comp, method: :delete, data: { confirm: 'Are you sure?' },class: "btn btn-danger" %>
                            </div>
                              
                          </div>      
                        <%end%>
                      <%end%>
                    <%end%>
                  <%end%>      
                <%end%>    
              <%end%>    
            <%end%>
          <%end%>  
          </div> 
        </div> 
      </div>
    </div>  
  </div>
</div>
<div class= "container-fluid">
  <div class="collapse" id="collapseExample">   
    <div class= "row">
      <div class= "col-sm-12 card card-body">
        <h1 align="center"> Añadir Comprador </h1>
        <% domrol = DomainRol.find_by(domain_id: params[:id]) %>
        <%= form_with model: @comprador, url: compradors_path ,id: :formulary, remote: true do |form| %>
                                    
          <div class = "col">
            <%= form.label "Tipo" %>
          </div>
          <div class = "col">
            <%= form.radio_button :type_member, 'Natural', onchange: "get_value(this)" %> 
            <%= label :type_member_Natural, 'Natural' %>
            <%= form.radio_button :type_member, 'Legal', onchange: "get_value(this)" %>
            <%= label :type_member_Empresa, 'Legal' %>
          </div>
                                        
          <div class = "col">
            <%= form.label "Miembro" %>
            <%= form.select :persona_id , options_for_select([["Seleccione", 0]]), {include_blank: "Seleccione"} ,class:"custom-select mr-sm-2"%>
          </div>

          <div class="col">
            <%= form.label :acciones %>
            <%= form.number_field :acciones, class: "form-control", oninput: "f_percentage(this)"%>
                                            
          </div>

          <div class="col">
            <%= form.label :percentage %>
            <%= form.text_field :percentage, class:"form-control", readonly: true %>
          </div>

          <%= form.hidden_field :domain_rol_id, value: domrol.id %>
          <br>
          <div class= "col">
            <div class="actions">
              <%= form.submit 'Guardar', class: "btn btn-primary"%>
            </div>
          </div>  
        <% end %>
      </div>
    </div>
  </div>      
</div>
<div class= "container-fluid">
  <div class= "row">
    <div class= "col-sm-12 card card-body">
      <% LegalPersona.order(:id).each do |legalp| %>
        <% if legalp.id == @domain.domainable_id%>
          <h1 align= "center">Documentos de <%= legalp.name %> </h1>
        <%end%>
      <%end%>    
      <br>
      <%= link_to new_domain_domainfile_path(@domain), class: "btn btn-primary" do %>
      <%= fa_icon "plus"%> Nuevo documento
      <% end %>
      <br>
      <table class= "table table-bordered table-hover">
        <thead class= "thead-dark">
          <tr>
          <th scope= "col">Documento</th>
          <th scope= "col">Observacion</th>
          <th scope= "col">Opciones</th>
          </tr>
        </thead>
        <tbody class= "rounded-pill">
          <% Domainfile.order(:id).each do |domfiles|%>
            <% if domfiles.domain_id == @domain.id%>
            <tr>
              <% if domfiles.file_name != "" %>
                <td scope= "row"><%= link_to domfiles.file_name.to_s.split('/')[5], File.join(root_url.to_s,domfiles.file_name.to_s)%> </td>
              <%else %>
                <td scope= "row">Sin Archivo</td>
              <% end %>
              <td><%= domfiles.obs_string %></td>
              <td>
                <%= link_to 'Ver', domfiles , class: "btn btn-info" %>
                <%= link_to 'Edit', edit_domainfile_path(domfiles) , class: "btn btn-warning" %>
                <%= link_to 'Borrar', domfiles, method: :delete, data: { confirm: 'Esta seguro?' } ,class: "btn btn-danger"%>
              </td>
            </tr>
            <%end%>
          <%end%>
      </table>
    </div>
  </div>
</div>
<div class="container-fluid">
  <% unless @domain.inscriptions.nil? %>
  <div class="row">
    <div class="col-sm-12 card card-body">
      <% LegalPersona.order(:id).each do |legalp| %>
        <% if legalp.id == @domain.domainable_id%>
          <h1 align="center">Inscripciones de <%= legalp.name %> </h1>
        <%end%>
      <%end%>  
      <br>
      <%= link_to new_domain_inscription_path(@domain),class: "btn btn-primary" do%>
      <%= fa_icon "plus"%> Nueva Inscripcion
      <% end %>
      <br>
      <table class="table table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th scope="col">foja</th>
            <th scope="col">número</th>
            <th scope="col">año</th>
            <th scope="col">cbrs</th>
            <th scope="col">Opciones</th>
          </tr>
        </thead>
        <tbody class="rounded-pill">
          <% @domain.inscriptions.each do |inscription| %>
          <tr>
            <td scope="row"><%= inscription.foja %></td>
            <td><%= inscription.number %></td>
            <td><%= inscription.year %></td>
            <td><%= inscription.cbrs %></td>
            <td>
              <%= link_to 'ver', inscription ,class: "btn btn-info"%>
              <%= link_to 'editar', edit_domain_inscription_path(inscription),class: "btn btn-warning" %>
            </td>
          </tr>
          <%end%>
        </tbody>
        </thead>
      </table>
    </div>
  </div>
  <% end %>
</div>

<script>
  function get_value(params) {
    if(params.value == "Natural") {
      var list = '<option value= 0>Seleccione persona natural</option>'
      <%Persona.order(:name).each do |persona| %>
        list += '<option value= <%= persona.id%>> <%= persona.name%> <%=persona.last_name1 %> / <%= persona.rut%> </option>'
      <%end%>
      $('select#persona_id').html(list);    
    } else {
      var list = '<option value= 0>Seleccione empresa</option>'
      <%LegalPersona.order(:name).each do |empresa| %>
        list += '<option value= <%= empresa.id%>> <%= empresa.name%> / <%= empresa.rut %> </option>'
      <%end%>
      $('select#persona_id').html(list); 
    }
  }
  function f_percentage(params) {
    <% @domain = Domain.find(params[:id]) %>
    var y = <%= @domain.price %>
    console.log(y); 
    var x = ((params.value * 100)/y).toFixed(2)
    document.getElementById('percentage').value = x.toString();
  }
</script>